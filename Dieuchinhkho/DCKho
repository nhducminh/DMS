# %%
import datetime as dt
import os
import time
import pandas as pd
import pytz


# %%
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import Select


# %%
end = dt.datetime.now(pytz.timezone("Asia/Bangkok")).date().strftime(format="%d/%m/%Y")
begin = (dt.datetime.now(pytz.timezone("Asia/Bangkok")).date() - dt.timedelta(days=7)).strftime(format="%d/%m/%Y")
curdir = os.path.abspath(os.curdir)
print(curdir)

###############

download_path = f"{curdir}/Dieuchinhkho"

# Define ChromeDriver service
service = Service("/usr/local/bin/chromedriver")  # Adjust the path if needed
# Set Chrome options for headless mode and download directory
chrome_options = webdriver.ChromeOptions()
chrome_options.add_argument("--headless")
chrome_options.add_argument("--no-sandbox")
chrome_options.add_argument("--disable-dev-shm-usage")
chrome_options.binary_location = "/usr/bin/google-chrome"  # Replace with the path to the Edge binary
# Set the download directory
chrome_options.add_experimental_option("prefs", {"download.default_directory": download_path})

# Start the WebDriver
browser = webdriver.Chrome(service=service, options=chrome_options)


# %%
def login(browser):
    browser.get("https://dpm.dmsone.vn/login")

    # Login to DMS
    try:
        elem = browser.find_element(By.NAME, "username")  # Find the Username
        elem.send_keys("madmin")
        elem = browser.find_element(By.NAME, "password")  # Find the Password
        elem.send_keys("PVFCCo@2023" + Keys.RETURN)
        print("Page Title", browser.title)
        time.sleep(5)
        elem = browser.find_element(By.ID, "spHeaderShopInf")
        print("Page Title", elem.text)
        return 1
    except Exception as e:
        print(e)
        print("quit")
        browser.quit()
        return -1


# %%


# %%
def dieuChinhKho(maC1, fileDieuChinhKho):
    urlDieuChinhKho = "https://dpm.dmsone.vn/stock/update/info"
    browser.get(urlDieuChinhKho)
    print(browser.title)
    time.sleep(5)

    try:
        listshop = browser.find_element(
            By.XPATH, '//*[@id="content"]/div[2]/div[1]/div/div[1]/div[1]/div[1]/span/input[1]'
        )
        listshop.clear()
        listshop.send_keys(maC1)
        time.sleep(1)

        listshop.send_keys(Keys.ENTER)
        listshop.send_keys(Keys.ENTER)

        time.sleep(1)

        btnInputFile_ = browser.find_element(By.ID, "btnInputFile_")
        btnInputFile_.click()

        time.sleep(1)
        UploadFileStyle = browser.find_element(By.CLASS_NAME, "UploadFileStyle")
        try:
            UploadFileStyle.send_keys(fileDieuChinhKho)
        except Exception as e:
            print(e)
        print(UploadFileStyle.text)
        time.sleep(1)
        browser.find_element(By.XPATH, "/html/body/div[11]/div[2]/div/div/div/div/div[4]/button[1]").click()
        time.sleep(1)
        browser.find_element(By.XPATH, "/html/body/div[33]/div[2]/div[4]/a[1]/span/span").click()

    except Exception as e:
        print(e)
    wait = 1
    while True:
        time.sleep(1)
        wait += 1
        try:
            maPhieuDC = browser.find_element(By.ID, "code").get_attribute("value")
            if maPhieuDC != "":
                break
        except:
            print(wait)
            pass
        if wait > 20:
            print(f"time out {wait}")
            return -1
    print(f"maPhieuDC {maPhieuDC}")

    #
    print(f"typeReason Mua hàng từ công ty")
    time.sleep(2)
    typeReason = browser.find_element(By.ID, "typeReason")
    select = Select(typeReason)
    select.select_by_visible_text("Mua hàng từ công ty")
    time.sleep(2)
    # lưu thay đổi
    print("btnUpdate_")
    browser.find_element(By.ID, "btnUpdate_").click()
    time.sleep(2)
    btnOK = browser.find_elements(By.CLASS_NAME, "l-btn-text")
    for btn in btnOK:
        if btn.text == "Đồng ý":
            btn.click()
            print("Đồng ý")

    return 1


# %%

browser.get("https://dpm.dmsone.vn/login")
login(browser)
resultdieuChinhKho = dieuChinhKho("C1MT", rf"{curdir}/Dieuchinhkho/DieuChinhkho_KHO_MT.xls")
print(resultdieuChinhKho)
